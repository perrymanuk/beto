# ADK Migration from 0.3.0 to 0.4.0

This document outlines the necessary steps to migrate our RadBot project from Google ADK 0.3.0 to 0.4.0. The changes in this version appear to be evolutionary rather than revolutionary, providing mostly improvements and additions rather than major breaking changes.

## Change Summary

Based on the changelog and documentation review, ADK 0.4.0 includes the following significant changes:

1. Minimum version of google-genai is now 1.11.0
2. Fixed typo in method name: `has_trailing_code_exeuction_result` -> `has_trailing_code_execution_result`
3. New CLI tool: `adk create` to help creating agents
4. Added `--verbosity` option to `adk deploy cloud_run` for detailed logging
5. Improved error messages for DatabaseSessionService initialization
6. Lazy loading for Google 1P tools to minimize initial latency
7. Added support for emitting state-change-only events from planners
8. Dev UI improvements:
   - Show planner thoughts and actions
   - Support for MCP tools
   - Auto-select the only app if only one app is available
   - Show grounding links generated by Google Search Tool
9. Fixed LiteLlm arg parsing errors and Python 3.9 compatibility
10. Added support for async before/after tool callbacks
11. Added `--replay` and `--resume` options to adk run CLI
12. Added Integration Connector Tool to prevent forcing LLM to provide default values
13. Added `custom_metadata` field to LlmResponse for tagging via after_model_callback

## Major Updates - Google GenAI SDK Change

During our migration process, we discovered a significant change in Google's AI SDKs ecosystem. The `google-generativeai` package is now considered legacy/deprecated, and Google is strongly recommending migration to their new unified Google GenAI SDK (`google-genai`). The older package will only receive critical bug fixes until its end-of-life on August 31st, 2025.

As part of this migration, we've also updated our dependencies to use the newer `google-genai` package instead of the deprecated `google-generativeai` package.

**Important Note**: After examining our codebase, we found that we're not directly using `google-generativeai` in our code. The ADK library is the only component that might be using it internally. This makes our migration simpler as we don't need to update any import statements in our code. We only need to update the dependency in pyproject.toml.

## Upgrade Steps

### 1. Update Dependencies in pyproject.toml

Update the `google-adk` dependency in pyproject.toml to require version 0.4.0 or higher:

```toml
"google-adk>=0.4.0",
```

Replace the `google-generativeai` dependency with the new `google-genai` package:

```toml
"google-genai>=1.11.0",  # New recommended Google GenAI SDK
```

### 2. Check Code for Breaking Changes

1. **Method Name Change**: 
   - If your code uses `has_trailing_code_exeuction_result`, update it to use `has_trailing_code_execution_result` instead.
   - This is unlikely to affect us since we don't appear to be using this method directly.

2. **Async Tool Callbacks**:
   - If we're using before/after tool callbacks, consider updating them to be async for improved performance.
   - Current usage doesn't appear to be affected, but could be a future optimization.

### 3. Dev UI and Deployment

1. **MCP Tool Support**:
   - The new version has improved support for MCP tools in the Dev UI
   - Our current implementation using MCP for filesystem and Home Assistant should work better

2. **Deployment Options**:
   - When using `adk deploy cloud_run`, we can now use the `--verbosity` option for more detailed logs
   - New options `--replay` and `--resume` are available for `adk run` CLI

### 4. Testing

1. Run the updated project locally to verify that:
   - The agent still loads correctly
   - All tools continue to function
   - MCP integrations work as expected

2. Verify that the Dev UI displays correctly and shows:
   - Planner thoughts and actions if using planners
   - Grounding links from Google Search Tool
   - MCP tools integration

### 5. Additional Features to Consider

1. **Lazy Loading for Google 1P Tools**:
   - This should improve initial latency without code changes

2. **custom_metadata Field**:
   - Consider using the new `custom_metadata` field in LlmResponse for better tagging and tracking responses

3. **Integration Connector Tool**:
   - If we're using ApplicationIntegrationToolSet, this new feature prevents forcing LLM to provide default values

## Post-Migration Updates

After the migration, we needed to make several adjustments to our codebase:

1. **Fix Import Paths**: The project structure had evolved over time, with modules moved into subdirectories. This migration provided an opportunity to clean up and standardize all import paths. Key changes:
   - Updated memory_tools imports from `radbot.tools.memory_tools` to `radbot.tools.memory.memory_tools`
   - Updated mcp_tools imports from `radbot.tools.mcp_tools` to `radbot.tools.mcp.mcp_tools`
   - Updated mcp_utils imports from `radbot.tools.mcp_utils` to `radbot.tools.mcp.mcp_utils`

2. **Test Suite Updates**: We fixed several test files that were failing due to outdated import paths:
   - `test_enhanced_memory.py`: Updated patch decorators to point to new module locations
   - `test_mcp_tools.py`: Updated imports and patch decorators
   - `test_mcp_utils.py`: Updated imports and fixed function references
   - `test_memory.py`: Updated imports for the memory tools

3. **Agent Transfer Fix**: We corrected an issue where the Scout agent couldn't transfer back to the main agent. This was resolved by updating the target agent name from 'radbot_web' to 'main' in the `radbot.agent.research_agent.instructions.py` file.

## Conclusion

The migration from ADK 0.3.0 to 0.4.0 required updating the ADK dependency version and migrating from the deprecated `google-generativeai` package to the new `google-genai` package. This involved updating the dependencies in pyproject.toml. Since we're not directly using `google-generativeai` in our codebase, we didn't need to update any import statements.

The migration also provided an opportunity to standardize our import paths and fix other minor issues in the codebase. After implementing these changes, we thoroughly tested the agent's functionality to ensure everything works as expected with the newer ADK version and Google GenAI SDK.

These updates have improved the maintainability of our codebase and ensured compatibility with the latest versions of the ADK and Google GenAI SDKs.
